<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChessForge</title>

    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/board.css">
    <link rel="stylesheet" href="css/game-status.css">
    <link rel="stylesheet" href="css/asset-modal.css">
    <link rel="stylesheet" href="css/move-history.css">
    <link rel="stylesheet" href="css/bot-panel.css">
</head>

<body>
    <h2>Chess Forage</h2>

    <div class="user-profile" style="text-align: center; margin-bottom: 15px;">
        <span id="welcome-message" style="font-weight: bold; margin-right: 15px;"></span>
        <button id="logout-btn" type="button" style="background: #ff4757; color: white;">ðŸšª Logout</button>
    </div>

    <div class="controls">
        <button id="change-img" type="button">ðŸŽ¨ Customize Pieces</button>
        <button id="toggle-style-btn" type="button">Switch to Unicode</button>
        <button id="reset-btn" type="button">Reset Game</button>
        <button id="sound-toggle-btn" type="button">ðŸ”Š Sound ON</button>
        <input type="range" id="volume-slider" min="0" max="100" value="50" title="Volume">
    </div>

    <div class="game-container">
        <div id="gameStatus">White to move</div>
        <div class="board" id="board"></div>
    </div>

    <!--
        Step 1: Load chess.js as a module, set window.Chess, then load app.
        Using an inline module ensures Chess is set before index.js runs,
        since all type="module" scripts are deferred and run in DOM order.
    -->
    <script type="module">
        import { Chess } from '/vendor/chess.js';
        window.Chess = Chess;
        // Dynamically import the app AFTER Chess is set on window
        const { createBoard } = await import('./js/board.js');
        const { updateGameStatus } = await import('./js/game-control.js');
        const { setupEventListeners } = await import('./js/ui-handlers.js');
        const { buildModal } = await import('./js/asset-modal.js');
        const { buildSidebar } = await import('./js/move-history.js');

        // Auth guard
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
        }

        const userName = localStorage.getItem("userName") || "Player";
        const welcomeSpan = document.getElementById("welcome-message");
        if (welcomeSpan) welcomeSpan.textContent = `Welcome, ${userName}!`;

        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                localStorage.removeItem("token");
                localStorage.removeItem("userName");
                window.location.href = "login.html";
            });
        }

        // Boot
        buildSidebar();
        buildModal();
        createBoard();
        updateGameStatus();
        setupEventListeners();
    </script>
</body>
</html>